# =============================================================================
# BIZNESPILOT - CONTINUOUS DEPLOYMENT (CD)
# =============================================================================
# Triggers: Push to main branch (after CI passes)
# Actions: Deploy to production server via SSH
# =============================================================================

name: CD - Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:  # Manual trigger option

# Only run if CI passes
concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: true

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '20'

jobs:
  # ---------------------------------------------------------------------------
  # Deploy to Production Server
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    # Only deploy if CI workflow passed
    needs: []
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, mbstring, pdo, redis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Composer dependencies (production)
        run: composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader

      - name: Install NPM dependencies
        run: npm ci

      - name: Build production assets
        run: npm run build

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          # Sync files to server (excluding sensitive files)
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='.env' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            --exclude='tests' \
            --exclude='phpunit.xml' \
            --exclude='.claude' \
            ./ $SERVER_USER@$SERVER_HOST:$SERVER_PATH/

      - name: Run deployment commands on server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            cd ${{ secrets.SERVER_PATH }}

            echo "ðŸ”„ Running migrations..."
            php artisan migrate --force

            echo "ðŸ”„ Clearing caches..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan event:cache

            echo "ðŸ”„ Restarting queue workers..."
            php artisan queue:restart

            echo "ðŸ”„ Setting permissions..."
            chmod -R 775 storage bootstrap/cache

            echo "âœ… Deployment completed!"
          ENDSSH

      - name: Notify deployment success
        if: success()
        run: echo "âœ… Deployment to production completed successfully!"

      - name: Notify deployment failure
        if: failure()
        run: echo "âŒ Deployment failed! Check the logs for details."
