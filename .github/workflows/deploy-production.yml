# =============================================================================
# BIZNESPILOT - PRODUCTION DEPLOYMENT (CD)
# =============================================================================
# Triggers: Push to main branch (after CI passes)
# Actions: Deploy to production server
# =============================================================================

name: CD - Deploy Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (emergency deploy)'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '20'

jobs:
  # ---------------------------------------------------------------------------
  # Run Tests First (unless skipped)
  # ---------------------------------------------------------------------------
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != 'true' }}

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: biznespilot_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, redis

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Prepare environment
        run: |
          cp .env.example .env
          php artisan key:generate
          sed -i 's/DB_CONNECTION=.*/DB_CONNECTION=mysql/' .env
          sed -i 's/DB_HOST=.*/DB_HOST=127.0.0.1/' .env
          sed -i 's/DB_DATABASE=.*/DB_DATABASE=biznespilot_test/' .env
          sed -i 's/DB_USERNAME=.*/DB_USERNAME=root/' .env
          sed -i 's/DB_PASSWORD=.*/DB_PASSWORD=password/' .env

      - name: Run migrations
        run: php artisan migrate --force

      - name: Run tests
        run: php artisan test

  # ---------------------------------------------------------------------------
  # Build Assets
  # ---------------------------------------------------------------------------
  build:
    name: Build Assets
    runs-on: ubuntu-latest
    needs: test
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build production assets
        run: npm run build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-assets
          path: public/build
          retention-days: 1

  # ---------------------------------------------------------------------------
  # Deploy to Production Server
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
      url: https://biznespilot.uz

    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-assets
          path: public/build

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          # Create deployment script
          cat > deploy_remote.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -e

          cd $DEPLOY_PATH

          echo "üì¶ Pulling latest code..."
          git fetch origin main
          git reset --hard origin/main

          echo "üì• Installing Composer dependencies..."
          composer install --no-dev --optimize-autoloader --no-interaction

          echo "üîÑ Running migrations..."
          php artisan migrate --force

          echo "üßπ Clearing caches..."
          php artisan config:clear
          php artisan cache:clear
          php artisan route:clear
          php artisan view:clear

          echo "‚ö° Caching configuration..."
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          php artisan event:cache

          echo "üîÑ Restarting queue workers..."
          php artisan queue:restart

          echo "‚úÖ Deployment completed!"
          DEPLOY_SCRIPT

          # Copy and execute
          scp deploy_remote.sh $SERVER_USER@$SERVER_HOST:/tmp/deploy_remote.sh
          ssh $SERVER_USER@$SERVER_HOST "chmod +x /tmp/deploy_remote.sh && DEPLOY_PATH=$DEPLOY_PATH /tmp/deploy_remote.sh"

      - name: Sync build assets
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          rsync -avz --delete public/build/ $SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/public/build/

      - name: Health check
        env:
          HEALTH_URL: ${{ secrets.HEALTH_URL }}
        run: |
          echo "üè• Running health check..."
          sleep 5

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL/health/ready" || echo "000")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ Health check passed!"
          else
            echo "‚ùå Health check failed! Status: $HTTP_STATUS"
            exit 1
          fi

      - name: Notify on success
        if: success()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d parse_mode="HTML" \
              -d text="‚úÖ <b>BiznesPilot Production Deployment</b>%0A%0Aüì¶ Commit: ${{ github.sha }}%0Aüë§ By: ${{ github.actor }}%0Aüîó <a href='https://github.com/${{ github.repository }}/commit/${{ github.sha }}'>View commit</a>"
          fi

      - name: Notify on failure
        if: failure()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d parse_mode="HTML" \
              -d text="‚ùå <b>BiznesPilot Deployment FAILED</b>%0A%0Aüì¶ Commit: ${{ github.sha }}%0Aüë§ By: ${{ github.actor }}%0Aüîó <a href='https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'>View logs</a>"
          fi

  # ---------------------------------------------------------------------------
  # Rollback (Manual trigger only)
  # ---------------------------------------------------------------------------
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'workflow_dispatch'
    needs: deploy

    steps:
      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Rollback on server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST << 'EOF'
            cd $DEPLOY_PATH
            echo "‚è™ Rolling back to previous commit..."
            git reset --hard HEAD~1
            composer install --no-dev --optimize-autoloader --no-interaction
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan queue:restart
            echo "‚úÖ Rollback completed!"
          EOF
