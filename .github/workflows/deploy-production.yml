# =============================================================================
# BIZNESPILOT - PRODUCTION DEPLOYMENT (CD)
# =============================================================================
# Triggers: Manual only (workflow_dispatch)
# Build: On GitHub Actions
# Deploy: Rsync built assets to server
# =============================================================================

name: üöÄ Deploy to Production

on:
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Testlarni otkazib yuborish"
        required: false
        default: false
        type: boolean
      skip_build:
        description: "Build otkazib yuborish (faqat kod deploy)"
        required: false
        default: false
        type: boolean

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '20'

jobs:
  # ---------------------------------------------------------------------------
  # Run Tests (optional)
  # ---------------------------------------------------------------------------
  test:
    name: üß™ Run Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != 'true' }}

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: biznespilot_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, redis, dom, bcmath

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Prepare environment
        run: |
          cp .env.example .env
          php artisan key:generate
          sed -i 's/DB_CONNECTION=.*/DB_CONNECTION=mysql/' .env
          sed -i 's/DB_HOST=.*/DB_HOST=127.0.0.1/' .env
          sed -i 's/DB_DATABASE=.*/DB_DATABASE=biznespilot_test/' .env
          sed -i 's/DB_USERNAME=.*/DB_USERNAME=root/' .env
          sed -i 's/DB_PASSWORD=.*/DB_PASSWORD=password/' .env

      - name: Run migrations
        run: php artisan migrate --force

      - name: Run tests
        run: php artisan test

  # ---------------------------------------------------------------------------
  # Build Frontend Assets on GitHub
  # ---------------------------------------------------------------------------
  build:
    name: üî® Build Assets
    runs-on: ubuntu-latest
    needs: test
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped') && github.event.inputs.skip_build != 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build production assets
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-assets
          path: public/build
          retention-days: 7

  # ---------------------------------------------------------------------------
  # Deploy to Production Server
  # ---------------------------------------------------------------------------
  deploy:
    name: üöÄ Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    if: always() && (needs.build.result == 'success' || needs.build.result == 'skipped')
    environment:
      name: production
      url: https://biznespilot.uz

    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        if: ${{ github.event.inputs.skip_build != 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: build-assets
          path: public/build

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy code to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST << ENDSSH
            set -e
            cd $DEPLOY_PATH

            echo "üì¶ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            echo "üì• Installing Composer dependencies..."
            composer install --no-dev --optimize-autoloader --no-interaction

            echo "üîÑ Running migrations..."
            php artisan migrate --force

            echo "üßπ Clearing caches..."
            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear

            echo "‚ö° Rebuilding caches..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan event:cache

            echo "üîÑ Restarting queue workers..."
            php artisan queue:restart

            echo "‚úÖ Code deployment completed!"
          ENDSSH

      - name: Upload build assets to server
        if: ${{ github.event.inputs.skip_build != 'true' }}
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          echo "üì§ Uploading build assets..."
          rsync -avz --delete public/build/ $SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/public/build/
          echo "‚úÖ Assets uploaded!"

      - name: Set permissions
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST << ENDSSH
            cd $DEPLOY_PATH
            chown -R www-data:www-data storage bootstrap/cache public/build
            chmod -R 775 storage bootstrap/cache
          ENDSSH

      - name: Health check
        run: |
          echo "üè• Running health check..."
          sleep 5

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.HEALTH_URL }}/health/ready" || echo "000")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ Health check passed!"
          else
            echo "‚ùå Health check failed! Status: $HTTP_STATUS"
            exit 1
          fi

      - name: Notify on success
        if: success()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            COMMIT_MSG="Manual deploy"
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d parse_mode="HTML" \
              -d text="‚úÖ <b>BiznesPilot Deploy Success</b>%0A%0Aüì¶ Branch: main%0Aüë§ By: ${{ github.actor }}%0Aüí¨ $COMMIT_MSG%0A%0Aüîó <a href='https://biznespilot.uz'>Open Site</a>"
          fi

      - name: Notify on failure
        if: failure()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d parse_mode="HTML" \
              -d text="‚ùå <b>BiznesPilot Deploy FAILED</b>%0A%0Aüë§ By: ${{ github.actor }}%0Aüîó <a href='https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'>View Logs</a>"
          fi
